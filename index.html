<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Chatty â€“ Discreet Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
    body {
        margin: 0; padding: 0;
        font-family: Arial; 
        background: #111; 
        color: #fff;
        transition: 0.3s;
    }
    .light { background:#f5f5f5; color:#000; }
    #container { max-width: 600px; margin:auto; padding:20px; }
    #messages { height: 60vh; overflow-y: auto; padding-bottom:20px; }
    .msg { margin: 10px 0; padding:10px; border-radius:10px; max-width:75%; }
    .me { background:#0084ff; color:white; margin-left:auto; }
    .other { background:#333; }
    #typing { opacity:0.6; font-style:italic; }
    #inputBox { display:flex; gap:10px; margin-top:10px; }
    input, button { padding:10px; border-radius:5px; border:none; }
    #file { display:none; }
    .toggle { cursor:pointer; padding:5px; float:right; }
</style>
</head>

<body>
<div id="container">

<h2>Chatty ðŸ”’  
<span class="toggle" onclick="toggleMode()">ðŸŒ“</span>
</h2>

<div>
    <input id="username" placeholder="Enter username..." style="width:100%;margin-bottom:10px;">
    <button onclick="saveUsername()" style="width:100%;background:#0084ff;color:white;">Continue</button>
</div>

<div id="chatArea" style="display:none;">
    <div id="messages"></div>
    <div id="typing"></div>

    <div id="inputBox">
        <input id="messageInput" placeholder="Type a message..." style="flex:1;">
        <label for="file">ðŸ“Ž</label>
        <input type="file" id="file" accept="image/*,video/*" />
        <button onclick="sendMessage()">Send</button>
    </div>
</div>


<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { 
    getFirestore, collection, addDoc, serverTimestamp,
    onSnapshot, query, orderBy, deleteDoc, doc 
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { 
    getStorage, ref, uploadBytes, getDownloadURL 
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyCGQbqa--bzkcpqjUwITnp5DMrMkrJNJ2E",
  authDomain: "chatty-1fd18.firebaseapp.com",
  projectId: "chatty-1fd18",
  storageBucket: "chatty-1fd18.firebasestorage.app",
  messagingSenderId: "37722991844",
  appId: "1:37722991844:web:c516568a0c4a899a6dd0f1",
  measurementId: "G-4FL9WXWDDP"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

let username = localStorage.getItem("chatName");

// UI
document.getElementById("username").value = username || "";

function saveUsername() {
    const name = document.getElementById("username").value.trim();
    if (!name) return;
    username = name;
    localStorage.setItem("chatName", name);
    document.querySelector("div").style.display="none";
    document.getElementById("chatArea").style.display="block";
}

if (username) {
    document.querySelector("div").style.display="none";
    document.getElementById("chatArea").style.display="block";
}

// Auto delete after 30 mins
async function cleanupOldMessages() {
    const now = Date.now();
    const cutoff = now - (30 * 60 * 1000);

    const qSnap = await onSnapshot(query(collection(db,"messages")), () => {});
}

// Listen for messages
const messagesRef = collection(db,"messages");
const q = query(messagesRef, orderBy("timestamp"));
onSnapshot(q, snapshot => {
    const msgBox = document.getElementById("messages");
    msgBox.innerHTML = "";

    snapshot.forEach(docSnap => {
        const data = docSnap.data();
        const time = data.timestamp ? data.timestamp.toMillis() : 0;

        // auto delete
        if (Date.now() - time > 30*60*1000) {
            deleteDoc(doc(messagesRef, docSnap.id));
            return;
        }

        const div = document.createElement("div");
        div.className = "msg " + (data.user === username ? "me" : "other");

        if (data.type === "text") {
            div.innerHTML = `<b>${data.user}</b><br>${data.text}`;
        } else {
            div.innerHTML = `<b>${data.user}</b><br>
                <${data.format === "image" ? "img" : "video"} 
                src="${data.url}" style="max-width:100%;" ${data.format==="video"?"controls":""}></${data.format === "image" ? "img" : "video"}>`;
        }

        msgBox.appendChild(div);
    });

    msgBox.scrollTop = msgBox.scrollHeight;
});


// Send text or media
async function sendMessage() {
    const input = document.getElementById("messageInput");
    const file = document.getElementById("file").files[0];

    if (file) {
        const fileRef = ref(storage, "uploads/" + Date.now() + "_" + file.name);
        await uploadBytes(fileRef, file);
        const url = await getDownloadURL(fileRef);

        const format = file.type.startsWith("image") ? "image" : "video";

        await addDoc(messagesRef, {
            user: username,
            type: "media",
            format: format,
            url: url,
            timestamp: serverTimestamp()
        });

        document.getElementById("file").value = "";
        return;
    }

    if (input.value.trim() === "") return;

    await addDoc(messagesRef, {
        user: username,
        type: "text",
        text: input.value,
        timestamp: serverTimestamp()
    });

    input.value = "";
}


// Dark/Light toggle
function toggleMode() {
    document.body.classList.toggle("light");
}

</script>

</body>
</html>
